    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        console.log('üöÄ SCRIPT INICIADO');

        const SUPABASE_URL = 'https://zofxhfbjgvpbqjtlkbbk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvZnhoZmJqZ3ZwYnFqdGxrYmJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNzY2MDAsImV4cCI6MjA4MTc1MjYwMH0.cOkzl5m_FzkACi6yc7398VKNhefK3I_JcRN8df1ILzM';

        let todasIgrejas = [];
        let supabase;

        function checkSession() {
            const session = localStorage.getItem('adminSession');
            if (!session) {
                window.location.href = 'login.html';
                return false;
            }

            const sessionData = JSON.parse(session);
            const now = new Date().getTime();
            
            if (now > sessionData.expires) {
                localStorage.removeItem('adminSession');
                alert('Sess√£o expirada. Fa√ßa login novamente.');
                window.location.href = 'login.html';
                return false;
            }

            document.getElementById('userEmail').textContent = sessionData.email;
            return true;
        }

        function logout() {
            localStorage.removeItem('adminSession');
            window.location.href = 'login.html';
        }

        function iniciar() {
            console.log('üì• Inicializando...');

            if (typeof window.supabase === 'undefined') {
                console.error('‚ùå Supabase n√£o carregou');
                alert('Erro ao carregar sistema');
                return;
            }

            const { createClient } = window.supabase;
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('‚úÖ Supabase criado');

            if (checkSession()) {
                carregarDados();
            }
        }

        function carregarDados() {
            console.log('üì• Carregando dados...');

            Promise.all([
                supabase.from('igrejas').select('*').order('nome'),
                supabase.from('vendas').select('igreja_id, valor_comissao').not('igreja_id', 'is', null)
            ])
            .then(function(results) {
                const igrejasResult = results[0];
                const vendasResult = results[1];

                console.log('üìä Igrejas:', igrejasResult);
                console.log('üìä Vendas:', vendasResult);

                if (igrejasResult.error) throw igrejasResult.error;

                todasIgrejas = igrejasResult.data || [];

                // Estat√≠sticas
                const vendas = vendasResult.data || [];
                const igrejasComVendas = new Set(vendas.map(v => v.igreja_id)).size;
                const totalComissoes = vendas.reduce((sum, v) => sum + parseFloat(v.valor_comissao || 0), 0);

                document.getElementById('totalIgrejas').textContent = todasIgrejas.length;
                document.getElementById('igrejasComVendas').textContent = igrejasComVendas;
                document.getElementById('totalComissoes').textContent = 'R$ ' + totalComissoes.toFixed(2);

                renderizarIgrejas(todasIgrejas);

                // Busca
                document.getElementById('searchInput').addEventListener('input', function() {
                    const termo = this.value.toLowerCase().trim();
                    
                    if (!termo) {
                        renderizarIgrejas(todasIgrejas);
                        return;
                    }

                    const filtradas = todasIgrejas.filter(function(i) {
                        return (
                            (i.nome && i.nome.toLowerCase().includes(termo)) ||
                            (i.cidade && i.cidade.toLowerCase().includes(termo)) ||
                            (i.estado && i.estado.toLowerCase().includes(termo)) ||
                            (i.pastor && i.pastor.toLowerCase().includes(termo))
                        );
                    });

                    renderizarIgrejas(filtradas);
                });

                document.getElementById('loadingOverlay').classList.add('hidden');
                console.log('‚úÖ Carregamento completo');
            })
            .catch(function(error) {
                console.error('‚ùå Erro:', error);
                alert('Erro ao carregar dados: ' + error.message);
                document.getElementById('loadingOverlay').classList.add('hidden');
            });
        }

        function renderizarIgrejas(igrejas) {
            const tbody = document.getElementById('igrejasTableBody');
            tbody.innerHTML = '';

            if (!igrejas || igrejas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 30px;">Nenhuma igreja encontrada.</td></tr>';
                return;
            }

            igrejas.forEach(function(igreja) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${igreja.nome}</strong></td>
                    <td>${igreja.cidade || 'N/A'}${igreja.estado ? ', ' + igreja.estado : ''}</td>
                    <td>${igreja.pastor || 'N/A'}</td>
                    <td>${igreja.telefone || 'N/A'}</td>
                    <td>${igreja.email || 'N/A'}</td>
                    <td><strong>${igreja.percentual_comissao}%</strong></td>
                    <td>
                        <button class="btn-action btn-edit" onclick="editarIgreja('${igreja.id}')">
                            ‚úèÔ∏è Editar
                        </button>
                        <button class="btn-action btn-delete" onclick="deletarIgreja('${igreja.id}', '${igreja.nome}')">
                            üóëÔ∏è Excluir
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            console.log('‚úÖ Renderizadas', igrejas.length, 'igrejas');
        }

        function abrirModalNova() {
            document.getElementById('modalTitle').textContent = 'Nova Igreja';
            document.getElementById('formIgreja').reset();
            document.getElementById('igreja_id').value = '';
            document.getElementById('percentual_comissao').value = '15';
            document.getElementById('modalIgreja').classList.add('active');
        }

        function fecharModal() {
            document.getElementById('modalIgreja').classList.remove('active');
            document.getElementById('alertContainer').innerHTML = '';
        }

        function editarIgreja(id) {
            const igreja = todasIgrejas.find(i => i.id === id);
            if (!igreja) return;

            document.getElementById('modalTitle').textContent = 'Editar Igreja';
            document.getElementById('igreja_id').value = igreja.id;
            document.getElementById('nome').value = igreja.nome || '';
            document.getElementById('cidade').value = igreja.cidade || '';
            document.getElementById('estado').value = igreja.estado || '';
            document.getElementById('pastor').value = igreja.pastor || '';
            document.getElementById('telefone').value = igreja.telefone || '';
            document.getElementById('email').value = igreja.email || '';
            document.getElementById('percentual_comissao').value = igreja.percentual_comissao || 15;
            document.getElementById('observacoes').value = igreja.observacoes || '';
            
            document.getElementById('modalIgreja').classList.add('active');
        }

        async function deletarIgreja(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir a igreja "${nome}"?`)) return;

            try {
                const { error } = await supabase
                    .from('igrejas')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('Igreja exclu√≠da com sucesso!');
                carregarDados();

            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert('Erro ao excluir igreja: ' + error.message);
            }
        }

        document.getElementById('formIgreja').addEventListener('submit', async function(e) {
            e.preventDefault();

            const igrejaId = document.getElementById('igreja_id').value;
            const igrejaData = {
                nome: document.getElementById('nome').value,
                cidade: document.getElementById('cidade').value,
                estado: document.getElementById('estado').value,
                pastor: document.getElementById('pastor').value,
                telefone: document.getElementById('telefone').value,
                email: document.getElementById('email').value,
                percentual_comissao: parseFloat(document.getElementById('percentual_comissao').value),
                observacoes: document.getElementById('observacoes').value
            };

            try {
                let result;

                if (igrejaId) {
                    result = await supabase
                        .from('igrejas')
                        .update(igrejaData)
                        .eq('id', igrejaId)
                        .select();
                } else {
                    result = await supabase
                        .from('igrejas')
                        .insert([igrejaData])
                        .select();
                }

                if (result.error) throw result.error;

                showAlert(igrejaId ? 'Igreja atualizada!' : 'Igreja cadastrada!', 'success');
                
                setTimeout(function() {
                    fecharModal();
                    carregarDados();
                }, 1500);

            } catch (error) {
                console.error('‚ùå Erro:', error);
                showAlert('Erro: ' + error.message, 'error');
            }
        });

        function showAlert(message, type) {
            document.getElementById('alertContainer').innerHTML = '<div class="alert alert-' + type + '">' + message + '</div>';
        }

        // Inicializar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(iniciar, 1000);
            });
        } else {
            setTimeout(iniciar, 1000);
        }
    </script>
</body>
</html>
