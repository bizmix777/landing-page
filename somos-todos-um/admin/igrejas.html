<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Igrejas - Somos Todos Um</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2rem;
        }

        .header p {
            color: #666;
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .card-header h2 {
            color: #333;
            font-size: 1.5rem;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 40px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
            margin-right: 5px;
        }

        .btn-edit {
            background: #ffc107;
            color: #333;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close {
            font-size: 2rem;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 25px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state p {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .card-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: 100%;
            }

            .table-container {
                overflow-x: scroll;
            }

            table {
                font-size: 0.875rem;
            }

            th, td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèõÔ∏è Gest√£o de Igrejas</h1>
        <p>Gerencie as igrejas parceiras do projeto Somos Todos Um</p>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="abrirModal()">‚ûï Nova Igreja</button>
          <a href="/admin/dashboard-comissoes.html" class="btn btn-secondary">üìä Dashboard</a>
          <a href="/admin/venda.html" class="btn btn-secondary">üõí Nova Venda</a>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>üìã Lista de Igrejas</h2>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Buscar por nome..." onkeyup="filtrarIgrejas()">
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Carregando igrejas...</p>
        </div>

        <div class="table-container" id="tableContainer" style="display: none;">
            <table id="igrejasTable">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Respons√°vel</th>
                        <th>Contato</th>
                        <th>Cidade/Estado</th>
                        <th>Comiss√£o</th>
                        <th>Status</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="igrejasTableBody">
                </tbody>
            </table>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <p>üì≠ Nenhuma igreja cadastrada ainda</p>
            <button class="btn btn-primary" onclick="abrirModal()">Cadastrar Primeira Igreja</button>
        </div>
    </div>

    <!-- Modal -->
    <div id="modalIgreja" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nova Igreja</h2>
                <span class="close" onclick="fecharModal()">&times;</span>
            </div>

            <form id="formIgreja" onsubmit="salvarIgreja(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nome">Nome da Igreja: *</label>
                        <input type="text" id="nome" required>
                    </div>

                    <div class="form-group">
                        <label for="responsavel">Respons√°vel:</label>
                        <input type="text" id="responsavel">
                    </div>

                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email">
                    </div>

                    <div class="form-group">
                        <label for="telefone">Telefone:</label>
                        <input type="tel" id="telefone">
                    </div>

                    <div class="form-group">
                        <label for="whatsapp">WhatsApp:</label>
                        <input type="tel" id="whatsapp">
                    </div>

                    <div class="form-group">
                        <label for="endereco">Endere√ßo:</label>
                        <input type="text" id="endereco">
                    </div>

                    <div class="form-group">
                        <label for="cidade">Cidade:</label>
                        <input type="text" id="cidade">
                    </div>

                    <div class="form-group">
                        <label for="estado">Estado:</label>
                        <select id="estado">
                            <option value="">Selecione...</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amap√°</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Cear√°</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Esp√≠rito Santo</option>
                            <option value="GO">Goi√°s</option>
                            <option value="MA">Maranh√£o</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Par√°</option>
                            <option value="PB">Para√≠ba</option>
                            <option value="PR">Paran√°</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piau√≠</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rond√¥nia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">S√£o Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="cep">CEP:</label>
                        <input type="text" id="cep">
                    </div>

                    <div class="form-group">
                        <label for="percentual_comissao">Percentual de Comiss√£o (%):</label>
                        <input type="number" id="percentual_comissao" step="0.01" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label for="chave_pix">Chave PIX (para receber comiss√£o):</label>
                        <input type="text" id="chave_pix">
                    </div>

                    <div class="form-group">
                        <label for="tipo_chave_pix">Tipo de Chave PIX:</label>
                        <select id="tipo_chave_pix">
                            <option value="">Selecione...</option>
                            <option value="cpf">CPF</option>
                            <option value="cnpj">CNPJ</option>
                            <option value="email">Email</option>
                            <option value="telefone">Telefone</option>
                            <option value="aleatoria">Chave Aleat√≥ria</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="ativo">Status:</label>
                        <select id="ativo">
                            <option value="true">Ativo</option>
                            <option value="false">Inativo</option>
                        </select>
                    </div>
                </div>

                <input type="hidden" id="igrejaId">

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://pqkqgvdnwmfhbfqjzquu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxa3FndmRud21maGJmcWp6cXV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQxMTI4NTYsImV4cCI6MjA0OTY4ODg1Nn0.kTvfhLlLdTh1SbKYLVB7HZvRm_4lZ0OXAJQMlFiXYtc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let igrejasData = [];

        async function carregarIgrejas() {
            try {
                const { data, error } = await supabase
                    .from('igrejas')
                    .select('*')
                    .order('nome', { ascending: true });

                if (error) throw error;

                igrejasData = data || [];
                renderizarIgrejas(igrejasData);
            } catch (error) {
                console.error('Erro ao carregar igrejas:', error);
                alert('Erro ao carregar igrejas. Verifique o console.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderizarIgrejas(igrejas) {
            const tbody = document.getElementById('igrejasTableBody');
            const tableContainer = document.getElementById('tableContainer');
            const emptyState = document.getElementById('emptyState');

            if (igrejas.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';

            tbody.innerHTML = igrejas.map(igreja => `
                <tr>
                    <td><strong>${igreja.nome || '-'}</strong></td>
                    <td>${igreja.responsavel || '-'}</td>
                    <td>
                        ${igreja.email ? `üìß ${igreja.email}<br>` : ''}
                        ${igreja.telefone ? `üìû ${igreja.telefone}` : ''}
                    </td>
                    <td>${igreja.cidade || '-'}/${igreja.estado || '-'}</td>
                    <td>${igreja.percentual_comissao ? igreja.percentual_comissao + '%' : '-'}</td>
                    <td>
                        <span class="badge ${igreja.ativo ? 'badge-success' : 'badge-danger'}">
                            ${igreja.ativo ? '‚úì Ativo' : '‚úó Inativo'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-edit" onclick="editarIgreja(${igreja.id})">‚úèÔ∏è Editar</button>
                        <button class="btn btn-sm btn-delete" onclick="excluirIgreja(${igreja.id})">üóëÔ∏è Excluir</button>
                    </td>
                </tr>
            `).join('');
        }

        function filtrarIgrejas() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const igrejasFiltradas = igrejasData.filter(igreja => 
                igreja.nome.toLowerCase().includes(searchTerm)
            );
            renderizarIgrejas(igrejasFiltradas);
        }

        function abrirModal() {
            document.getElementById('modalTitle').textContent = 'Nova Igreja';
            document.getElementById('formIgreja').reset();
            document.getElementById('igrejaId').value = '';
            document.getElementById('modalIgreja').style.display = 'block';
        }

        function fecharModal() {
            document.getElementById('modalIgreja').style.display = 'none';
        }

        async function editarIgreja(id) {
            const igreja = igrejasData.find(i => i.id === id);
            if (!igreja) return;

            document.getElementById('modalTitle').textContent = 'Editar Igreja';
            document.getElementById('igrejaId').value = igreja.id;
            document.getElementById('nome').value = igreja.nome || '';
            document.getElementById('responsavel').value = igreja.responsavel || '';
            document.getElementById('email').value = igreja.email || '';
            document.getElementById('telefone').value = igreja.telefone || '';
            document.getElementById('whatsapp').value = igreja.whatsapp || '';
            document.getElementById('endereco').value = igreja.endereco || '';
            document.getElementById('cidade').value = igreja.cidade || '';
            document.getElementById('estado').value = igreja.estado || '';
            document.getElementById('cep').value = igreja.cep || '';
            document.getElementById('percentual_comissao').value = igreja.percentual_comissao || '';
            document.getElementById('chave_pix').value = igreja.chave_pix || '';
            document.getElementById('tipo_chave_pix').value = igreja.tipo_chave_pix || '';
            document.getElementById('ativo').value = igreja.ativo ? 'true' : 'false';

            document.getElementById('modalIgreja').style.display = 'block';
        }

        async function salvarIgreja(event) {
            event.preventDefault();

            const igrejaData = {
                nome: document.getElementById('nome').value,
                responsavel: document.getElementById('responsavel').value,
                email: document.getElementById('email').value,
                telefone: document.getElementById('telefone').value,
                whatsapp: document.getElementById('whatsapp').value,
                endereco: document.getElementById('endereco').value,
                cidade: document.getElementById('cidade').value,
                estado: document.getElementById('estado').value,
                cep: document.getElementById('cep').value,
                percentual_comissao: parseFloat(document.getElementById('percentual_comissao').value) || 0,
                chave_pix: document.getElementById('chave_pix').value,
                tipo_chave_pix: document.getElementById('tipo_chave_pix').value,
                ativo: document.getElementById('ativo').value === 'true'
            };

            const igrejaId = document.getElementById('igrejaId').value;

            try {
                let result;
                if (igrejaId) {
                    result = await supabase
                        .from('igrejas')
                        .update(igrejaData)
                        .eq('id', igrejaId);
                } else {
                    result = await supabase
                        .from('igrejas')
                        .insert([igrejaData]);
                }

                if (result.error) throw result.error;

                alert(igrejaId ? 'Igreja atualizada com sucesso!' : 'Igreja cadastrada com sucesso!');
                fecharModal();
                carregarIgrejas();
            } catch (error) {
                console.error('Erro ao salvar igreja:', error);
                alert('Erro ao salvar igreja. Verifique o console.');
            }
        }

        async function excluirIgreja(id) {
            if (!confirm('Tem certeza que deseja excluir esta igreja?')) return;

            try {
                const { error } = await supabase
                    .from('igrejas')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('Igreja exclu√≠da com sucesso!');
                carregarIgrejas();
            } catch (error) {
                console.error('Erro ao excluir igreja:', error);
                alert('Erro ao excluir igreja. Verifique o console.');
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('modalIgreja');
            if (event.target === modal) {
                fecharModal();
            }
        }

        carregarIgrejas();
    </script>
</body>
</html>
