    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        console.log('üöÄ SCRIPT INICIADO');

        const SUPABASE_URL = 'https://zofxhfbjgvpbqjtlkbbk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpvZnhoZmJqZ3ZwYnFqdGxrYmJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNzY2MDAsImV4cCI6MjA4MTc1MjYwMH0.cOkzl5m_FzkACi6yc7398VKNhefK3I_JcRN8df1ILzM';
        
        const PRECO_LIVRO = 29.90;
        let supabase;

        // Fun√ß√£o para inicializar
        function iniciar() {
            console.log('üì• Inicializando...');

            if (typeof window.supabase === 'undefined') {
                console.error('‚ùå Supabase n√£o carregou');
                document.getElementById('igreja_id').innerHTML = '<option value="">Erro ao carregar</option>';
                return;
            }

            const { createClient } = window.supabase;
            supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('‚úÖ Supabase criado');

            carregarIgrejas();
        }

        // Carregar igrejas
        function carregarIgrejas() {
            console.log('üì• Carregando igrejas...');

            supabase
                .from('igrejas')
                .select('*')
                .order('nome')
                .then(function(response) {
                    console.log('üìä RESPOSTA:', response);

                    if (response.error) {
                        console.error('‚ùå ERRO:', response.error);
                        document.getElementById('igreja_id').innerHTML = '<option value="">Erro: ' + response.error.message + '</option>';
                        return;
                    }

                    const igrejas = response.data;
                    console.log('‚úÖ IGREJAS:', igrejas);

                    const select = document.getElementById('igreja_id');
                    select.innerHTML = '<option value="">Selecione uma igreja</option>';

                    if (!igrejas || igrejas.length === 0) {
                        select.innerHTML = '<option value="">Nenhuma igreja cadastrada</option>';
                        return;
                    }

                    for (let i = 0; i < igrejas.length; i++) {
                        const igreja = igrejas[i];
                        const option = document.createElement('option');
                        option.value = igreja.id;
                        option.textContent = igreja.nome + ' - ' + igreja.percentual_comissao + '%';
                        option.setAttribute('data-percentual', igreja.percentual_comissao);
                        option.setAttribute('data-nome', igreja.nome);
                        select.appendChild(option);
                    }

                    console.log('‚úÖ Dropdown preenchido com', igrejas.length, 'igrejas');

                    // Verificar URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const igrejaId = urlParams.get('igreja');
                    if (igrejaId) {
                        select.value = igrejaId;
                        select.dispatchEvent(new Event('change'));
                    }

                    setupEventos();
                })
                .catch(function(error) {
                    console.error('‚ùå ERRO CATCH:', error);
                    document.getElementById('igreja_id').innerHTML = '<option value="">Erro: ' + error.message + '</option>';
                });
        }

        // Setup eventos
        function setupEventos() {
            console.log('‚öôÔ∏è Configurando eventos...');

            // Mudan√ßa de igreja
            document.getElementById('igreja_id').addEventListener('change', function() {
                const option = this.options[this.selectedIndex];
                if (option.value) {
                    const percentual = parseFloat(option.getAttribute('data-percentual')) || 0;
                    const nome = option.getAttribute('data-nome');
                    calcularComissao(percentual, nome);
                } else {
                    document.getElementById('percentual_comissao').value = '0%';
                    document.getElementById('valor_comissao').value = 'R$ 0,00';
                    document.getElementById('resumo_igreja').textContent = 'N√£o selecionada';
                    document.getElementById('resumo_comissao').textContent = 'R$ 0,00';
                }
            });

            // Mudan√ßa de quantidade
            document.getElementById('quantidade').addEventListener('input', function() {
                const select = document.getElementById('igreja_id');
                const option = select.options[select.selectedIndex];
                if (option.value) {
                    const percentual = parseFloat(option.getAttribute('data-percentual')) || 0;
                    const nome = option.getAttribute('data-nome');
                    calcularComissao(percentual, nome);
                }
                calcularResumo();
            });

            // Submit
            document.getElementById('formVenda').addEventListener('submit', submeterVenda);

            console.log('‚úÖ Eventos configurados');
        }

        function calcularComissao(percentual, nomeIgreja) {
            const quantidade = parseInt(document.getElementById('quantidade').value) || 1;
            const valorTotal = quantidade * PRECO_LIVRO;
            const valorComissao = valorTotal * (percentual / 100);

            document.getElementById('percentual_comissao').value = percentual + '%';
            document.getElementById('valor_comissao').value = 'R$ ' + valorComissao.toFixed(2);
            document.getElementById('resumo_igreja').textContent = nomeIgreja;
            document.getElementById('resumo_comissao').textContent = 'R$ ' + valorComissao.toFixed(2);

            calcularResumo();
        }

        function calcularResumo() {
            const quantidade = parseInt(document.getElementById('quantidade').value) || 1;
            const valorTotal = quantidade * PRECO_LIVRO;

            document.getElementById('resumo_quantidade').textContent = quantidade;
            document.getElementById('resumo_total').textContent = 'R$ ' + valorTotal.toFixed(2);
        }

        async function submeterVenda(e) {
            e.preventDefault();

            console.log('üì§ Submetendo venda...');

            const btnSubmit = document.getElementById('btnSubmit');
            btnSubmit.disabled = true;
            btnSubmit.textContent = '‚è≥ Processando...';

            const igrejaId = document.getElementById('igreja_id').value;
            if (!igrejaId) {
                showAlert('Por favor, selecione uma igreja.', 'error');
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'üõí FINALIZAR VENDA';
                return;
            }

            const quantidade = parseInt(document.getElementById('quantidade').value) || 1;
            const valorTotal = quantidade * PRECO_LIVRO;
            const percentualComissao = parseFloat(document.getElementById('percentual_comissao').value) || 0;
            const valorComissao = valorTotal * (percentualComissao / 100);

            const vendaData = {
                igreja_id: igrejaId,
                nome_comprador: document.getElementById('nome_comprador').value,
                email_comprador: document.getElementById('email_comprador').value,
                telefone_comprador: document.getElementById('telefone_comprador').value,
                whatsapp_comprador: document.getElementById('telefone_comprador').value,
                quantidade: quantidade,
                valor_unitario: PRECO_LIVRO,
                valor_total: valorTotal,
                percentual_comissao: percentualComissao,
                valor_comissao: valorComissao,
                forma_pagamento: document.getElementById('forma_pagamento').value,
                status_pagamento: 'pendente',
                origem: 'venda_igreja'
            };

            console.log('üì¶ Dados:', vendaData);

            try {
                const { data, error } = await supabase
                    .from('vendas')
                    .insert([vendaData])
                    .select();

                if (error) throw error;

                console.log('‚úÖ Sucesso!');
                showAlert('‚úÖ Venda registrada com sucesso! ID: ' + data[0].id, 'success');
                
                document.getElementById('formVenda').reset();
                document.getElementById('igreja_id').value = '';
                calcularResumo();

                btnSubmit.disabled = false;
                btnSubmit.textContent = 'üõí FINALIZAR VENDA';

            } catch (error) {
                console.error('‚ùå Erro:', error);
                showAlert('‚ùå Erro: ' + error.message, 'error');
                
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'üõí FINALIZAR VENDA';
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = '<div class="alert alert-' + type + '">' + message + '</div>';
            
            setTimeout(function() {
                alertContainer.innerHTML = '';
            }, 8000);
        }

        // Inicializar quando carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(iniciar, 1000);
            });
        } else {
            setTimeout(iniciar, 1000);
        }

        calcularResumo();
    </script>
</body>
</html>
